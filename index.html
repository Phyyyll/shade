<!DOCTYPE html>
<html>
  <head>
    <title>Testing</title>
    <style>
      /* Add your CSS styles here */
      .highlighted {
        background-color: yellow;
      }
      .highlighted-like {
        background-color: green;
      }
      .highlighted-dislike {
        background-color: red;
      }
    </style>
  </head>
  <body>
    <form style="display: flex; flex-direction: column; gap: 24">
      <div style="display: flex; gap: 16px; align-items: center">
        <label>
          <input
            type="radio"
            name="action"
            value="green"
            onclick="setHighlightColor(this.value);"
          />
          Like
        </label>
        <label>
          <input
            type="radio"
            name="action"
            value="red"
            onclick="setHighlightColor(this.value);"
          />
          Dislike
        </label>
        <label>
          <input
            type="radio"
            name="action"
            value="yellow"
            onclick="setHighlightColor(this.value);"
          />
          Do not understand
        </label>
        <label>
          <input
            type="radio"
            name="action"
            value="transparent"
            onclick="setHighlightColor(this.value);"
          />
          Erase
        </label>
      </div>
      <div id="container" onmouseup="handleHighlight()">
        <p>
          Technology has transformed the way we live, work, and communicate.
          From the invention of the wheel to the creation of the internet, each
          new innovation has revolutionized society and opened up new
          possibilities. We now have the power to connect with people on the
          other side of the world in an instant, access a wealth of information
          at our fingertips, and even explore virtual realms through immersive
          virtual reality experiences.
        </p>
      </div>
    </form>
    <script>
      // Add your JavaScript code here
      let highlightColor = "green";
      let selectedButton = "Like"; // Default value
      let logMessages = []; // Array to store the log messages

      function setHighlightColor(color) {
        highlightColor = color;
        selectedButton = document
          .querySelector('input[name="action"]:checked')
          .nextSibling.textContent.trim();
      }

      function setStartButton() {
        selectedButton = "Start";
        highlightColor = "transparent"; // Reset the highlight color to "transparent"
      }

      function handleHighlight() {
        const highlighted = window.getSelection();
        if (!highlighted.toString().replace(/\s/g, "")) return;
        const range = highlighted.getRangeAt(0);
        document.designMode = "on";
        if (range) {
          highlighted.removeAllRanges();
          highlighted.addRange(range);
        }
        if (highlightColor !== "transparent") {
          document.execCommand("backColor", false, highlightColor);
        } else {
          document.execCommand("removeFormat");
        }
        document.designMode = "off";
        collectHighlightIndices(selectedButton);
        window.getSelection().removeAllRanges();
      }

      function collectHighlightIndices(button) {
        const container = document.getElementById("container");
        if (!container) return;

        const paragraph = container.querySelector("p");
        if (!paragraph) return;

        const selection = window.getSelection();
        if (!selection.toString()) return; // No highlighted text

        const range = selection.getRangeAt(0);
        const preSelectionRange = range.cloneRange();
        preSelectionRange.selectNodeContents(paragraph);
        preSelectionRange.setEnd(range.startContainer, range.startOffset);

        const startIdx = preSelectionRange.toString().length;
        const endIdx = startIdx + selection.toString().length - 1;

        let existingLogIndex = -1;
        for (let i = 0; i < logMessages.length; i++) {
          const log = logMessages[i];
          const matchStart = parseInt(log.message.match(/Start: (\d+)/)[1], 10);
          const matchEnd = parseInt(log.message.match(/End: (\d+)/)[1], 10);
          const logButton = log.message.match(/Type: (.+)/)[1];

          if (
            startIdx <= matchEnd &&
            endIdx >= matchStart &&
            logButton === button
          ) {
            // The new highlight overlaps with an existing highlight for the same button
            existingLogIndex = i;
            break;
          }
        }

        if (existingLogIndex !== -1) {
          // Update the "End" index of the existing log message
          const logMessage = logMessages[existingLogIndex].message;
          const updatedLogMessage = logMessage.replace(
            /End: \d+/,
            `End: ${endIdx}`
          );
          logMessages[existingLogIndex].message = updatedLogMessage;
        } else {
          // Format the log message and add a new entry to the logMessages array
          const logMessage = `%cStart: ${startIdx} - End: ${endIdx} - Type: ${button}`;
          const logColor = getLogColor(button);
          logMessages.push({ message: logMessage, color: logColor });
        }

        updateConsole();
      }

      function getLogColor(button) {
        switch (button) {
          case "Like":
            return "color: green;";
          case "Dislike":
            return "color: red;";
          case "Do not understand":
            return "color: yellow;";
          default:
            return "color: black;";
        }
      }

      function updateConsole() {
        // Clear previous logs
        console.clear();

        // Print consolidated logs
        for (const log of logMessages) {
          console.log(log.message, log.color);
        }
      }
    </script>
  </body>
</html>
